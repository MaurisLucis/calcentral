language: ruby
bundler_args: --without development production --deployment --jobs=4 --retry=5
cache: bundler
env: JRUBY_OPTS="--dev -J-Xmx900m" DISPLAY=:99.0 LOGGER_LEVEL=WARN
jdk: openjdk8
node_js: 10.1.0
os: linux
rvm: jruby-9.1.14.0

before_install:
  - gem install bundler -v '1.15.4'

jobs:
  include:
    - stage: Lint
      script:
        - echo $ALWAYS_RUN_TYPE_LINT
        - echo $ALWAYS_RUN_TYPE_RSPEC
        - echo $RUN_TYPE_DEPLOY
        - echo $TRAVIS_BRANCH
        - echo $TRAVIS_BUILD_NUMBER
        - echo $TRAVIS_COMMIT
        - echo $TRAVIS_EVENT_TYPE
        - echo $TRAVIS_JDK_VERSION
        - echo $TRAVIS_PULL_REQUEST
        - echo $TRAVIS_REPO_SLUG
        - echo $TRAVIS_RUBY_VERSION
    - # Lint JavaScript
      if: type = pull_request OR env(ALWAYS_RUN_TYPE_LINT) = 'true'
      script:
        - npm config set strict-ssl false
        - npm install
        - npm run build
        - npm run lint
    - # Lint SCSS (parallel with above)
      if: type = pull_request OR env(ALWAYS_RUN_TYPE_LINT) = 'true'
      script:
        - gem cleanup scss_lint
        - gem install scss_lint --version 0.49.0
        - scss-lint src/assets/stylesheets
    - # RSpec
      if: type = pull_request OR env(ALWAYS_RUN_TYPE_RSPEC) = 'true'
      script:
        - RAILS_ENV=test bundle exec rspec
    - stage: Post-merge
      if: repo = 'ets-berkeley-edu/calcentral' OR env(RUN_TYPE_DEPLOY) = 'true'
      script:
        - echo 'Running post-merge'
